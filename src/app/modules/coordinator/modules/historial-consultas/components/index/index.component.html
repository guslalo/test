<div class="row">
  <div class="col mb-3">
    <h2>Historial de Consultas</h2>
  </div>
  <div class="col">
    <button
      type="button"
      class="btn btn-primary rounded-pill float-right d-none"
      ng-reflect-tour-anchor="agendar"
      data-toggle="modal"
      data-target="#disponibilidad"
    >
      nueva consulta
      <svg
        width="1.5em"
        height="1.5em"
        viewBox="0 0 16 16"
        class="bi bi-plus-circle"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          d="M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"
        />
        <path fill-rule="evenodd" d="M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z" />
        <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
      </svg>
    </button>
  </div>
</div>

<div class="row">
  <div class="col-3">
    <input
      [(ngModel)]="searchTerm"
      type="text"
      class="form-control"
      placeholder="Busqueda"
      (keyup)="applyFiltersAppointments()"
    />
    <div class="searchBox">
      <img src="assets/icons/icon-search.svg" />
    </div>
  </div>
  <div class="col-3">
    <div class="form-group">
      <select
        [(ngModel)]="appointmentStatusSelected"
        class="form-control"
        id="status"
        (change)="applyFiltersAppointments()"
      >
        <option [ngValue]="null">Filtrar por Estado</option>
        <option ngValue="reserved">Reservada</option>
        <option ngValue="appointed">Agendada</option>
        <option ngValue="rescheduled">Re-Agendada</option>
        <option ngValue="active">Activa</option>
        <option ngValue="waitingInRoom">En Sala de Espera</option>
        <option ngValue="waitingInList">En Lista de Espera</option>
        <option ngValue="running">En Curso</option>
        <option ngValue="pending">Pendiente</option>
        <option ngValue="finished">Finalizada</option>
        <option ngValue="canceled">Cancelada</option>
      </select>
    </div>
  </div>
</div>
<!--appointments activas-->
<div class="row mt-1">
  <div class="col-12">
    <h5 style="display: none;">Mis appointments activas</h5>
  </div>
  <div class="col-12 mb-4">
    <div class="tableBox rounded p-4 bg-white">
      <ngx-datatable
        *ngIf="appointments?.length; else noData"
        class="material"
        [rows]="appointments"
        headerHeight="auto"
        footerHeight="auto"
        rowHeight="70"
        [columnMode]="ColumnMode.flex"
        [limit]="10"
        [selectAllRowsOnPage]="true"
      >
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="ID Paciente">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <span>{{
              row.patientDetails.userDetails[0]?.identificationData.cpf ||
                row.patientDetails.userDetails[0]?.identificationData.cns ||
                row.patientDetails.userDetails[0]?.identificationData.rgRegistry ||
                row.patientDetails.userDetails[0]?.identificationData.passport
            }}</span>
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="2" name="Nombre Paciente">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <img
              *ngIf="(row.patientDetails?.userDetails)[0]?.photo; else noPhoto"
              class="profile mr-2"
              id="image0"
              width="38"
              height="38"
              [src]="photoUrlBase + (row.patientDetails?.userDetails)[0]?.photo"
              alt="img"
            />
            <ng-template #noPhoto>
              <img class="profile mr-2" id="image0" width="38" height="38" src="/assets/profile.jpg" alt="img" />
            </ng-template>
            {{ row.patientDetails.userDetails[0]?.personalData.name || 'S/R' }}
            {{ row.patientDetails.userDetails[0]?.personalData.secondLastName }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Fecha">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.dateDetails.date | date: 'dd/MM/yyyy':'+0000' || 'S/R' }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Hora">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.dateDetails.start + ' hrs' }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Sala">
          <ng-template let-row="row" ngx-datatable-cell-template>S/R</ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Profesional">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.professionalDetails.userDetails[0]?.name || 'S/R' }}
            {{ row.professionalDetails.userDetails[0]?.lastName }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Estado">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <button
              *ngIf="row.administrativeDetails.status !== 'created'; else invalidStatus"
              type="button"
              class="btn btn-secondary rounded-pill btn-sm"
            >
              {{
                row.administrativeDetails.status === 'reserved'
                  ? 'Reservada'
                  : row.administrativeDetails.status === 'appointed'
                  ? 'Agendada'
                  : row.administrativeDetails.status === 'rescheduled'
                  ? 'Re-Agendada'
                  : row.administrativeDetails.status === 'active'
                  ? 'Activa'
                  : row.administrativeDetails.status === 'waitingInRoom'
                  ? 'En Sala de Espera'
                  : row.administrativeDetails.status === 'waitingInList'
                  ? 'En Lista de Espera'
                  : row.administrativeDetails.status === 'running'
                  ? 'En Curso'
                  : row.administrativeDetails.status === 'pending'
                  ? 'Pendiente'
                  : row.administrativeDetails.status === 'finished'
                  ? 'Finalizada'
                  : row.administrativeDetails.status === 'canceled'
                  ? 'Cancelada'
                  : null
              }}
            </button>
            <ng-template #invalidStatus>N/A</ng-template>
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column [resizeable]="false" [flexGrow]="1" name="Accion">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <ng-container *ngIf="row.administrativeDetails.status === 'finished'">
              <a routerLink="/app-professional/ficha-consulta/{{ row._id }}">
                <button type="button" class="btn btn-outline-secondary rounded-pill btn-sm">
                  Ver Ficha
                </button>
              </a>
            </ng-container>
            <ng-container
              *ngIf="
                row.administrativeDetails.status === 'running' ||
                row.administrativeDetails.status === 'active' ||
                row.administrativeDetails.status === 'appointed' ||
                row.administrativeDetails.status === 'pending'
              "
            >
              <a routerLink="/app-professional/crear-ficha-consulta/{{ row._id }}">
                <button type="button" class="btn btn-outline-secondary rounded-pill btn-sm">
                  Atender
                </button>
              </a>
            </ng-container>
          </ng-template>
        </ngx-datatable-column>
      </ngx-datatable>
      <ng-template #noData>
        <h5 class="text-center text-primary">No existen coincidencias</h5>
      </ng-template>
      <!--/tab-->
    </div>
  </div>
</div>
